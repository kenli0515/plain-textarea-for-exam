sequenceDiagram
    autonumber
    Mobile->>DDR: Login
    DDR->>Mobile: AccessToken
    Mobile->>Google/Apple: Subscription check
    Note over Mobile, Google/Apple: Scenerio 1: if this google account do not have subscription
        Google/Apple->>Mobile: No subscription
        Mobile->>DDR: Get subscription, orderId=null
        Note over DDR, Google/Apple: if DB.enddateIsNotExpired
            DDR->>Mobile: status=paid
        Note over DDR, Google/Apple: if DB.enddateIsExpired && DB.noOrderId
            DDR->>Mobile: status=free
        Note over DDR, Google/Apple: if DB.enddateIsExpired && DB.hasOrderId, orderId=456
                %% Still need to check the old plan if any, as user may renewed plan from another account
                DDR->>Google/Apple: Check subscription, DB.orderId=456
                alt if Google/Apple plan renewed
                    Google/Apple->>DDR: Plan renewed, newPlanEnddate=11/11/2022
                    DDR-->>DDR: update DB with new enddate=11/11/2022
                    DDR->>Mobile: check complete, status=paid
                else if Google/Apple plan expired
                    Google/Apple->>DDR: Plan expired
                    DDR->>Mobile: status=free
                end
        
    Note over Mobile, Google/Apple: Scenerio 2: if this google account have subscription
        Google/Apple->>Mobile: Valid subscription, orderId=123
        Mobile->>DDR: Get subscription, orderId=123
        alt if enddate is not expired in DB
            %% no need to check anything, as still within expiry date
            DDR->>Mobile: Check complete, status = paid
        else if enddate is expired already
            DDR->>Google/Apple: Check subscription, orderId=123
            Google/Apple->>DDR: Subscription is valid, orderId=123 & enddate=11/11/2022
            alt if orderId 123 already exist && DB.userId != request.userId
                DDR->>Mobile: Exception, orderId belongs to another user
            else if orderId is new || DB.userId == request.userId
                DDR-->>DDR: update DB with new enddate
                DDR->>Mobile: Check complete, status = paid
            end
        end
    
